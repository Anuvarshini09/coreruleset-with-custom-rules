SecRule REQUEST_HEADERS "@rx .+" \
    "id:100041,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.header_value=%{MATCHED_VAR}',\
    msg:'Captured header argument value: %{TX.header_value}'"

SecRule TX:header_value "@rx .+" \
    "id:100042,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"


SecRule TX:header_value "@rx .+" \
    "id:100043,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"


SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx (?i)cmd\s*=\s*\d{1,3}(\.\d{1,3}){3}\s*&&\s*ls\s+\/[^\s]+" \
    "id:100044,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"
