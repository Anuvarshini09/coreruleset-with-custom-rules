SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:100001,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_urlpath_value=%{TX.1}',\
    msg:'Captured URL path value: %{TX.raw_urlpath_value}'"

SecRule TX:raw_urlpath_value "@rx .+" \
    "id:100002,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

SecRule TX:raw_urlpath_value|TX:base64_decoded_value "@rx (?i)(<script[^>]*>.*?<\/script>|<script[^>]*src\s*=\s*['\"]?.*?['\"]?.*?>|<[^>]*on\w+\s*=\s*['\"]?.*?['\"]?|javascript:[^>]*|<svg[^>]*>.*?<\/svg>|<[^>]*src\s*=\s*['\"]?.*?['\"]?|alert\s*\(.*?\)|confirm\s*\(.*?\)|prompt\s*\(.*?\)|eval\s*\(.*?\)|setInterval\s*\(.*?\)|document\.domain|window\.location|constructor\s*\(.*?\)|apply\s*\(.*?\)|call\s*\(.*?\)|[\w\s]*=[^>]*\b(alert|prompt|confirm|eval|setInterval)\b.*?|\bon\w+\s*=\s*['\"]?.*?['\"]?|\(?\s*\b(alert|confirm|prompt|eval|setInterval)\b\s*\)\s*\(\s*.*?\s*\))" \
    "id:100003,phase:2,log,auditlog,block,\
    msg:'Detected XSS in URL path payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

SecRule ARGS_GET "@rx .+" \
    "id:100004,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_urlparam_value=%{MATCHED_VAR}',\
    msg:'Captured URL parameter value: %{TX.raw_urlparam_value}'"


SecRule TX:raw_urlparam_value "@rx .+" \
    "id:100005,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"


SecRule TX:raw_urlparam_value|TX:base64_decoded_value "@rx (?i)(<script[^>]*>.*?<\/script>|<script[^>]*src\s*=\s*['\"]?.*?['\"]?.*?>|<[^>]*on\w+\s*=\s*['\"]?.*?['\"]?|javascript:[^>]*|<svg[^>]*>.*?<\/svg>|<[^>]*src\s*=\s*['\"]?.*?['\"]?|alert\s*\(.*?\)|confirm\s*\(.*?\)|prompt\s*\(.*?\)|eval\s*\(.*?\)|setInterval\s*\(.*?\)|document\.domain|window\.location|constructor\s*\(.*?\)|apply\s*\(.*?\)|call\s*\(.*?\)|[\w\s]*=[^>]*\b(alert|prompt|confirm|eval|setInterval)\b.*?|\bon\w+\s*=\s*['\"]?.*?['\"]?|\(?\s*\b(alert|confirm|prompt|eval|setInterval)\b\s*\)\s*\(\s*.*?\s*\))" \
    "id:100006,phase:2,log,auditlog,block,\
    msg:'Detected XSS in URL parameter payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

SecRule ARGS "@rx .+" \
    "id:100007,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_htmlform_value=%{MATCHED_VAR}',\
    msg:'Captured HTML Form value: %{TX.raw_htmlform_value}'"


SecRule TX:raw_htmlform_value "@rx .+" \
    "id:100008,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"


SecRule TX:raw_htmlform_value|TX:base64_decoded_value "@rx (?i)(<script[^>]*>.*?<\/script>|<script[^>]*src\s*=\s*['\"]?.*?['\"]?.*?>|<[^>]*on\w+\s*=\s*['\"]?.*?['\"]?|javascript:[^>]*|<svg[^>]*>.*?<\/svg>|<[^>]*src\s*=\s*['\"]?.*?['\"]?|alert\s*\(.*?\)|confirm\s*\(.*?\)|prompt\s*\(.*?\)|eval\s*\(.*?\)|setInterval\s*\(.*?\)|document\.domain|window\.location|constructor\s*\(.*?\)|apply\s*\(.*?\)|call\s*\(.*?\)|[\w\s]*=[^>]*\b(alert|prompt|confirm|eval|setInterval)\b.*?|\bon\w+\s*=\s*['\"]?.*?['\"]?|\(?\s*\b(alert|confirm|prompt|eval|setInterval)\b\s*\)\s*\(\s*.*?\s*\))" \
    "id:100009,phase:2,log,auditlog,block,\
    msg:'Detected XSS in HTML Form payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

SecRule ARGS "@rx .+" \
    "id:100010,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_arg_value=%{MATCHED_VAR}',\
    msg:'Captured raw argument value: %{TX.raw_arg_value}'"


SecRule TX:raw_arg_value "@rx .+" \
    "id:100011,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

SecRule TX:raw_arg_value "@rx .+" \
    "id:100012,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"


SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx (?i)(<script[^>]*>.*?<\/script>|<script[^>]*src\s*=\s*['\"]?.*?['\"]?.*?>|<[^>]*on\w+\s*=\s*['\"]?.*?['\"]?|javascript:[^>]*|<svg[^>]*>.*?<\/svg>|<[^>]*src\s*=\s*['\"]?.*?['\"]?|alert\s*\(.*?\)|confirm\s*\(.*?\)|prompt\s*\(.*?\)|eval\s*\(.*?\)|setInterval\s*\(.*?\)|document\.domain|window\.location|constructor\s*\(.*?\)|apply\s*\(.*?\)|call\s*\(.*?\)|[\w\s]*=[^>]*\b(alert|prompt|confirm|eval|setInterval)\b.*?|\bon\w+\s*=\s*['\"]?.*?['\"]?|\(?\s*\b(alert|confirm|prompt|eval|setInterval)\b\s*\)\s*\(\s*.*?\s*\))" \
    "id:100013,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"


