SecRule REQUEST_HEADERS:User-Agent "@rx .+" \
    "id:100096,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.header_value=%{MATCHED_VAR}',\
    msg:'Captured header argument value: %{TX.header_value}'"

SecRule TX:header_value "@rx .+" \
    "id:100097,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"


SecRule TX:header_value "@rx .+" \
    "id:100098,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"

SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx (http:\/\/[a-zA-Z0-9.-]+\.burpcollaborator\.net\/[0-9]+\.[0-9]+\.[0-9]+\.RELEASE\s*iPhone[0-9,]+.*\)\)|Mozilla\/5\.0\s+\(Windows NT\s+[0-9.]+;\s*WOW64\)\s*AppleWebKit\/[0-9.]+\s*\(KHTML,\s+like\s+Gecko\)\s*Chrome\/[0-9.]+\s*Safari\/[0-9.]+\s*root@[a-zA-Z0-9.-]+\.interact\.sh|mercuryboard_user_agent_sql_injection\.nasl')" \
    "id:100099,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"
