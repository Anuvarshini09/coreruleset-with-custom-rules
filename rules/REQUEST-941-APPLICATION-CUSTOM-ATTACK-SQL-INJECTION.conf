#URLPath 
SecRule REQUEST_URI "@rx ^.*/([^/]+)$" \
    "id:100045,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_urlpath_value=%{TX.1}',\
    msg:'Captured URL path value: %{TX.raw_urlpath_value}'"

SecRule TX:raw_urlpath_value "@rx .+" \
    "id:100046,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

SecRule TX:raw_urlpath_value|TX:base64_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100047,phase:2,log,auditlog,block,\
    msg:'Detected XSS in URL path payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"
    

#HTMLMultiPartForm
SecRule ARGS "@rx .+" \
    "id:100048,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_arg_value=%{MATCHED_VAR}',\
    msg:'Captured raw argument value: %{TX.raw_arg_value}'"

# Step 2: Decode the captured payload as Base64
SecRule TX:raw_arg_value "@rx .+" \
    "id:100049,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

# Step 3: Decode the captured payload as URL-encoded
SecRule TX:raw_arg_value "@rx .+" \
    "id:100050,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"

# Step 4: Inspect both decoded values for malicious XSS patterns
SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100051,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"


#HTMLForm 

SecRule ARGS "@rx .+" \
    "id:100052,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_htmlform_value=%{MATCHED_VAR}',\
    msg:'Captured HTML Form value: %{TX.raw_htmlform_value}'"

# Step 2: Decode the captured value as Base64
SecRule TX:raw_htmlform_value "@rx .+" \
    "id:100053,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

# Step 3: Inspect both the automatically URL-decoded value and Base64-decoded value for malicious XSS patterns
SecRule TX:raw_htmlform_value|TX:base64_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100054,phase:2,log,auditlog,block,\
    msg:'Detected XSS in HTML Form payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"

#URLParam 

SecRule ARGS_GET "@rx .+" \
    "id:100055,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_urlparam_value=%{MATCHED_VAR}',\
    msg:'Captured URL parameter value: %{TX.raw_urlparam_value}'"

# Step 2: Decode the captured value as Base64
SecRule TX:raw_urlparam_value "@rx .+" \
    "id:100056,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

# Step 3: Inspect both the automatically URL-decoded value and Base64-decoded value for malicious XSS patterns
SecRule TX:raw_urlparam_value|TX:base64_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100057,phase:2,log,auditlog,block,\
    msg:'Detected XSS in URL parameter payload',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"


#JSONRequest

SecRule ARGS "@rx .+" \
    "id:100058,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.raw_arg_value=%{MATCHED_VAR}',\
    msg:'Captured raw argument value: %{TX.raw_arg_value}'"

# Step 2: Decode the captured payload as Base64
SecRule TX:raw_arg_value "@rx .+" \
    "id:100059,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

# Step 3: Decode the captured payload as URL-encoded
SecRule TX:raw_arg_value "@rx .+" \
    "id:100060,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"

# Step 4: Inspect both decoded values for malicious XSS patterns
SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100061,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"




#Header and #User-Agent
SecRule REQUEST_HEADERS "@rx .+" \
    "id:100062,phase:2,log,auditlog,pass,capture,\
    setvar:'tx.header_value=%{MATCHED_VAR}',\
    msg:'Captured header argument value: %{TX.header_value}'"

SecRule TX:header_value "@rx .+" \
    "id:100063,phase:2,log,auditlog,pass,t:base64Decode,t:htmlEntityDecode,capture,\
    setvar:'tx.base64_decoded_value=%{MATCHED_VAR}',\
    msg:'Base64-decoded value: %{TX.base64_decoded_value}'"

# Step 3: Decode the captured payload as URL-encoded
SecRule TX:header_value "@rx .+" \
    "id:100064,phase:2,log,auditlog,pass,t:urlDecodeUni,capture,\
    setvar:'tx.url_decoded_value=%{MATCHED_VAR}',\
    msg:'URL-decoded value: %{TX.url_decoded_value}'"

# Step 4: Inspect both decoded values for malicious XSS patterns
SecRule TX:base64_decoded_value|TX:url_decoded_value "@rx \bselect\s*\(\s*0\s*\)\s*from\s*\(select\s*\(sleep\s*\(\d+\)\)\)\s*v|EXEC\s+Master\.dbo\.xp_cmdshell|JSON_EXTRACT\(\s*'{''aKER'':\s*\d+}'\s*,\s*'\$.aKER'\)\s*=\s*\d+|JSON_DEPTH\(\s*'\{\}'\s*\)\s*!=\s*\d+" \
    "id:100065,phase:2,log,auditlog,block,\
    msg:'Decoded payload contains malicious XSS',severity:CRITICAL,\
    tag:'paranoia-level/4',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.inbound_anomaly_score_pl4=+%{tx.critical_anomaly_score}'"
